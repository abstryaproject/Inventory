<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Investment Tracker Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- SheetJS (Excel Library) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  body { font-family: Arial; background: #f5f6fa; margin:0; padding:0; }
  .app { max-width: 900px; margin: auto; padding:20px; }
  h1,h2 { text-align:center; }
  .summary { background:white; padding:15px; border-radius:10px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  button { width:100%; padding:12px; border:none; border-radius:8px; background:#1e90ff; color:white; font-size:16px; cursor:pointer; margin:5px 0;}
  button:hover { background:#0c75d8;}
  .trade { background:white; padding:10px; margin-top:10px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  .profit { color:green; } .loss { color:red; }
  .modal { display:none; position:fixed; z-index:10; left:0; top:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5);}
  .modal-content { background:white; margin:5% auto; padding:20px; border-radius:10px; max-width:450px;}
  .close { float:right; font-size:28px; cursor:pointer; }
  .modal input { width:100%; padding:10px; margin:5px 0; border-radius:8px; border:1px solid #ddd; }
  .filters { display:flex; justify-content:space-around; margin-bottom:15px; flex-wrap:wrap; }
  .filters button { width:auto; padding:8px 12px; font-size:14px; }
  canvas { background:white; border-radius:10px; padding:10px; margin-bottom:20px; }
</style>
</head>

<body>
<div class="app">

<h1>ğŸ“ˆ Investment Tracker Dashboard</h1>

<p style="text-align:center; color:gray;">
ğŸ’¡ New user? Start by adding a trade. Returning user? Import Excel.
</p>

<button id="openFormBtn">â• Add Trade</button>

<button onclick="document.getElementById('excelFile').click()">ğŸ“‚ Import Excel</button>
<input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none"/>

<button onclick="logoutAndExport()">ğŸšª Logout / Save to Excel</button>

<!-- Modal -->
<div id="tradeModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h2>Add / Edit Trade</h2>
    <input type="text" id="asset" placeholder="Asset / Share Name">
    <input type="number" id="buyPrice" placeholder="Buy Price">
    <input type="number" id="unitsBought" placeholder="Units Bought">
    <input type="datetime-local" id="buyDate">
    <input type="number" id="sellPrice" placeholder="Sell Price (optional)">
    <input type="number" id="unitsSold" placeholder="Units Sold (optional)">
    <input type="datetime-local" id="sellDate">
    <button id="saveTradeBtn">ğŸ’¾ Save Trade</button>
  </div>
</div>

<div class="filters">
  <button onclick="setFilter('All')">All Trades</button>
  <button onclick="setFilter('Open')">Open Trades</button>
  <button onclick="setFilter('Closed')">Closed Trades</button>
</div>

<div class="summary">
  <p>Total Invested: â‚¦<span id="totalInvested">0</span></p>
  <p>Total Profit/Loss: â‚¦<span id="totalProfit">0</span></p>
</div>

<div id="history"></div>

<h2>ğŸ“Š Profit/Loss per Trade</h2>
<canvas id="profitChart"></canvas>

<h2>ğŸ“Š Portfolio Composition</h2>
<canvas id="portfolioChart"></canvas>

<h2>ğŸ“Š Buy vs Sell</h2>
<canvas id="buySellChart"></canvas>

<h2>ğŸ“Š Remaining Shares</h2>
<canvas id="remainingChart"></canvas>

<h2>ğŸ“Š Cumulative Profit</h2>
<canvas id="cumulativeChart"></canvas>

</div>

<script>
let trades = JSON.parse(localStorage.getItem("trades")) || [];
let editIndex = null;
let filterStatus = "All";

let profitChartInstance, portfolioChartInstance, buySellChartInstance, remainingChartInstance, cumulativeChartInstance;

const modal = document.getElementById("tradeModal");
document.getElementById("openFormBtn").onclick = () => modal.style.display = "block";
document.getElementById("closeModal").onclick = () => closeModal();

function closeModal(){
  modal.style.display = "none";
  clearForm();
}

window.onclick = (e) => { if(e.target == modal) closeModal(); }

document.getElementById("saveTradeBtn").onclick = () => saveTrade(editIndex);

function saveTrade(index=null){
  const asset = document.getElementById("asset").value.trim();
  const buyPrice = parseFloat(document.getElementById("buyPrice").value);
  const unitsBought = parseFloat(document.getElementById("unitsBought").value);
  const buyDate = document.getElementById("buyDate").value || new Date().toISOString();
  const sellPrice = parseFloat(document.getElementById("sellPrice").value) || 0;
  const unitsSold = parseFloat(document.getElementById("unitsSold").value) || 0;
  const sellDate = document.getElementById("sellDate").value || "";

  if(!asset || !buyPrice || !unitsBought){
    alert("Fill Asset, Buy Price & Units Bought");
    return;
  }

  if(unitsSold > unitsBought){
    alert("Units sold cannot exceed units bought");
    return;
  }

  const sellValue = sellPrice * unitsSold;
  const profit = sellValue - (buyPrice * unitsSold);
  const remaining = unitsBought - unitsSold;

  const trade = {asset,buyPrice,unitsBought,buyDate,sellPrice,unitsSold,sellDate,buyValueTotal:buyPrice*unitsBought,sellValue,profit,remaining};

  if(index !== null) trades[index] = trade;
  else trades.push(trade);

  localStorage.setItem("trades", JSON.stringify(trades));

  renderTrades();
  closeModal();
}

function renderTrades(){
  const history = document.getElementById("history");
  history.innerHTML = "";

  let totalInvested = 0;
  let totalProfit = 0;

  const filteredTrades = trades.filter(t=>{
    const status = t.remaining === 0 ? "Closed" : "Open";
    if(filterStatus === "All") return true;
    return filterStatus === status;
  });

  filteredTrades.forEach((trade,i)=>{
    totalInvested += trade.buyValueTotal;
    totalProfit += trade.profit;

    history.innerHTML += `
      <div class="trade">
        <strong>${trade.asset}</strong><br>
        Buy: â‚¦${trade.buyPrice} Ã— ${trade.unitsBought}<br>
        Buy Date: ${new Date(trade.buyDate).toLocaleString()}<br>
        Sell: â‚¦${trade.sellPrice || "-"} Ã— ${trade.unitsSold || "-"}<br>
        Sell Date: ${trade.sellDate ? new Date(trade.sellDate).toLocaleString() : "-"}<br>
        Remaining: ${trade.remaining}<br>
        <span class="${trade.profit>=0?'profit':'loss'}">
          Profit/Loss: â‚¦${trade.profit.toFixed(2)}
        </span><br>
        <button onclick="editTrade(${i})">âœ Edit</button>
        <button style="background:red" onclick="deleteTrade(${i})">ğŸ—‘ Delete</button>
      </div>`;
  });

  document.getElementById("totalInvested").innerText = totalInvested.toFixed(2);
  document.getElementById("totalProfit").innerText = totalProfit.toFixed(2);

  renderCharts();
}

function editTrade(index){
  const t = trades[index];
  document.getElementById("asset").value = t.asset;
  document.getElementById("buyPrice").value = t.buyPrice;
  document.getElementById("unitsBought").value = t.unitsBought;
  document.getElementById("buyDate").value = t.buyDate.slice(0,16);
  document.getElementById("sellPrice").value = t.sellPrice;
  document.getElementById("unitsSold").value = t.unitsSold;
  document.getElementById("sellDate").value = t.sellDate ? t.sellDate.slice(0,16) : "";
  modal.style.display = "block";
  editIndex = index;
}

function deleteTrade(index){
  if(confirm("Delete this trade?")){
    trades.splice(index,1);
    localStorage.setItem("trades", JSON.stringify(trades));
    renderTrades();
  }
}

function clearForm(){
  document.querySelectorAll(".modal input").forEach(i=>i.value="");
  editIndex=null;
}

function setFilter(status){
  filterStatus=status;
  renderTrades();
}

function renderCharts(){
  const labels = trades.map(t=>t.asset);
  const profits = trades.map(t=>t.profit);
  const invested = trades.map(t=>t.buyValueTotal);
  const sell = trades.map(t=>t.sellValue);
  const remaining = trades.map(t=>t.remaining);

  let cumulative=0;
  const cumulativeData = trades.map(t=> cumulative += t.profit);

  if(profitChartInstance) profitChartInstance.destroy();
  profitChartInstance = new Chart(profitChart, {
    type:'bar',
    data:{labels,datasets:[{data:profits,backgroundColor:profits.map(p=>p>=0?'green':'red')}]}
  });

  if(portfolioChartInstance) portfolioChartInstance.destroy();
  portfolioChartInstance = new Chart(portfolioChart, {
    type:'doughnut',
    data:{labels,datasets:[{data:invested}]}
  });

  if(buySellChartInstance) buySellChartInstance.destroy();
  buySellChartInstance = new Chart(buySellChart, {
    type:'bar',
    data:{labels,datasets:[
      {label:'Buy',data:invested},
      {label:'Sell',data:sell}
    ]}
  });

  if(remainingChartInstance) remainingChartInstance.destroy();
  remainingChartInstance = new Chart(remainingChart, {
    type:'bar',
    data:{labels,datasets:[{data:remaining}]}
  });

  if(cumulativeChartInstance) cumulativeChartInstance.destroy();
  cumulativeChartInstance = new Chart(cumulativeChart, {
    type:'line',
    data:{labels,datasets:[{data:cumulativeData,fill:true}]}
  });
}

/* âœ… Excel Import */
excelFile.addEventListener('change', function(e){
  const file = e.target.files[0];
  const reader = new FileReader();

  reader.onload = function(event){
    const data = new Uint8Array(event.target.result);
    const workbook = XLSX.read(data, {type:'array'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);

    trades = json.map(row=>{
      const buyPrice = parseFloat(row.buyPrice)||0;
      const unitsBought = parseFloat(row.unitsBought)||0;
      const sellPrice = parseFloat(row.sellPrice)||0;
      const unitsSold = parseFloat(row.unitsSold)||0;
      const sellValue = sellPrice * unitsSold;
      const profit = sellValue - (buyPrice * unitsSold);
      const remaining = unitsBought - unitsSold;

      return {...row,buyPrice,unitsBought,sellPrice,unitsSold,sellValue,profit,remaining,buyValueTotal:buyPrice*unitsBought};
    });

    localStorage.setItem("trades", JSON.stringify(trades));
    renderTrades();
    alert("âœ… Excel Loaded");
  };

  reader.readAsArrayBuffer(file);
});

/* âœ… Logout â†’ Export Excel */
function logoutAndExport(){
  if(trades.length===0){
    alert("No data to export");
    return;
  }

  const exportData = trades.map(t=>({
    asset:t.asset,
    buyPrice:t.buyPrice,
    unitsBought:t.unitsBought,
    buyDate:t.buyDate,
    sellPrice:t.sellPrice,
    unitsSold:t.unitsSold,
    sellDate:t.sellDate
  }));

  const ws = XLSX.utils.json_to_sheet(exportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Trades");
  XLSX.writeFile(wb, "Investment_Trades.xlsx");

  trades=[];
  localStorage.removeItem("trades");
  renderTrades();
}

renderTrades();
</script>
</body>
</html>